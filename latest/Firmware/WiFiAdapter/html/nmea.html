<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>  
    <title>NMEA Setup</title>
    <link rel="stylesheet" href="css/forms.css"/>
    <script>
      async function loadForm() {
        let url = '/api/nmea';
        try {
          let res = await fetch(url);
          data = await res.json();
          //alert(JSON.stringify(data));
          document.forms[0].elements["mode"].value = data.mode;
          document.forms[0].elements["ip"].value = data.ip;
          document.forms[0].elements["port"].value = data.port;
        }
        catch(error) {
          alert(error);
        }
      }

      async function postData(obj)
      {
        json = JSON.stringify(obj);
        try {
          let res = await fetch('/api/nmea', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: json
          });
          response = await res;
          if ( response.ok )
          {
            document.location.reload();
          }
          else
          {
            alert("Response status: " + response.status);
          }
        }
        catch(error) {
          alert(error);
        }
      }

      function isValidIP(ip) 
      {
        if ( ip === undefined )
          return false;

        var arrIp = ip.split(".");
        if (arrIp.length !== 4) 
          return false;

        if ( Number(arrIp[0]) == 0 )
          return false;

        for (let oct of arrIp) {
          if ( isNaN(oct) || Number(oct) < 0 || Number(oct) > 255)
            return false;
        }
        return true;
      }

      function validate()
      {
        form = document.forms[0];
        mode = form.elements["mode"].value;
        if ( mode == 0 )
        {
          // We only need a valid port
          port = form.elements["port"].value;
          if ( port < 1024 || port > 65535 )
          {
            alert("Port must be in the range 1024-65535");
            return false;
          }
          
          obj = {mode: Number(mode), ip: "0.0.0.0", port: port};  
          postData(obj);
          return true;          
        }
        else 
        {
          // We need both a valid IP and port
          ip = form.elements["ip"].value;
          if ( !isValidIP(ip) )
          {
            alert("Please enter a proper IP address");
            return false;
          }

          port = form.elements["port"].value;
          if ( port < 1024 || port > 65535 )
          {
            alert("Port must be between 1024 and 65535");
            return false;
          }

          obj = {mode: Number(mode), ip: ip, port: port};  
          postData(obj);
          return true;
        }
      }
    </script>
  </head>
  <body onload="loadForm();"> 
    <center><h1>MAIANA&trade;</h1></center>
    <center><h2>NMEA Configuration</h2></center>

    <form>
      <fieldset>
        <legend>Mode</legend>
        <input type="radio" id="tcp_server" name="mode" value="0" checked/>
        <label for="tcp_server">TCP Listener</label>
        <br/>
        <input type="radio" id="udp_sender" name="mode" value="1"/>
        <label for="udp_sender">UDP Sender</label>
        </fieldset>
      <br/>
      <fieldset>
        <table>
          <tr>
            <td class="left-label">IP Address:</td>
            <td><input class="right-align-input" id="ip" type="text" name="ip" /></td>
          </tr>
          <tr>
            <td class="left-label">Port:</td>
            <td><input class="right-align-input" id="port" type="number" name="port"/></td>
          </tr>
        </table>
      </fieldset>
      <br/>
      <center><button type="button" onclick="validate();">Apply</button></center>

    </form>
  </body>
</html>
